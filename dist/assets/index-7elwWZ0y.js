var Cs=Object.defineProperty;var ks=(r,t,e)=>t in r?Cs(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var P=(r,t,e)=>ks(r,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const f of n.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&s(f)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();function Ss(r){return r!==null?{comment:r,variations:[]}:{variations:[]}}function ws(r,t,e,s,i){const n={move:r,variations:i};return t&&(n.suffix=t),e&&(n.nag=e),s!==null&&(n.comment=s),n}function As(...r){const[t,...e]=r;let s=t;for(const i of e)i!==null&&(s.variations=[i,...i.variations],i.variations=[],s=i);return t}function $s(r,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){const s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:r,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function Ps(r,t){function e(){this.constructor=r}e.prototype=t.prototype,r.prototype=new e}function Z(r,t,e,s){var i=Error.call(this,r);return Object.setPrototypeOf&&Object.setPrototypeOf(i,Z.prototype),i.expected=t,i.found=e,i.location=s,i.name="SyntaxError",i}Ps(Z,Error);function be(r,t,e){return e=e||" ",r.length>t?r:(t-=r.length,e+=e.repeat(t),r+e.slice(0,t))}Z.prototype.format=function(r){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<r.length;s++)if(r[s].source===this.location.source){e=r[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,n=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,f=this.location.source+":"+n.line+":"+n.column;if(e){var u=this.location.end,h=be("",n.line.toString().length," "),d=e[i.line-1],_=i.line===u.line?u.column:d.length+1,y=_-i.column||1;t+=`
 --> `+f+`
`+h+` |
`+n.line+" | "+d+`
`+h+" | "+be("",i.column-1," ")+be("",y,"^")}else t+=`
 at `+f}return t};Z.buildMessage=function(r,t){var e={literal:function(d){return'"'+i(d.text)+'"'},class:function(d){var _=d.parts.map(function(y){return Array.isArray(y)?n(y[0])+"-"+n(y[1]):n(y)});return"["+(d.inverted?"^":"")+_.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(d){return d.description}};function s(d){return d.charCodeAt(0).toString(16).toUpperCase()}function i(d){return d.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(_){return"\\x0"+s(_)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(_){return"\\x"+s(_)})}function n(d){return d.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(_){return"\\x0"+s(_)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(_){return"\\x"+s(_)})}function f(d){return e[d.type](d)}function u(d){var _=d.map(f),y,p;if(_.sort(),_.length>0){for(y=1,p=1;y<_.length;y++)_[y-1]!==_[y]&&(_[p]=_[y],p++);_.length=p}switch(_.length){case 1:return _[0];case 2:return _[0]+" or "+_[1];default:return _.slice(0,-1).join(", ")+", or "+_[_.length-1]}}function h(d){return d?'"'+i(d)+'"':"end of input"}return"Expected "+u(r)+" but "+h(t)+" found."};function Ts(r,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,i={pgn:Ze},n=Ze,f="[",u='"',h="]",d=".",_="O-O-O",y="O-O",p="0-0-0",w="0-0",E="$",$="{",A="}",Q=";",pe="(",ge=")",Le="1-0",qe="0-1",Ne="1/2-1/2",yt="*",_e=/^[a-zA-Z]/,Oe=/^[^"]/,re=/^[0-9]/,Me=/^[.]/,Ke=/^[a-zA-Z1-8\-=]/,Ct=/^[+#]/,Fe=/^[!?]/,Re=/^[^}]/,De=/^[^\r\n]/,Be=/^[ \t\r\n]/,kt=F("tag pair"),St=L("[",!1),Ue=L('"',!1),wt=L("]",!1),At=F("tag name"),me=U([["a","z"],["A","Z"]],!1,!1),$t=F("tag value"),Qe=U(['"'],!0,!1),Pt=F("move number"),ne=U([["0","9"]],!1,!1),Tt=L(".",!1),Ge=U(["."],!1,!1),xt=F("standard algebraic notation"),It=L("O-O-O",!1),Lt=L("O-O",!1),qt=L("0-0-0",!1),Nt=L("0-0",!1),He=U([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Ot=U(["+","#"],!1,!1),Mt=F("suffix annotation"),je=U(["!","?"],!1,!1),Kt=F("NAG"),Ft=L("$",!1),Rt=F("brace comment"),Dt=L("{",!1),Ve=U(["}"],!0,!1),Bt=L("}",!1),Ut=F("rest of line comment"),Qt=L(";",!1),We=U(["\r",`
`],!0,!1),Gt=F("variation"),Ht=L("(",!1),jt=L(")",!1),Vt=F("game termination marker"),Wt=L("1-0",!1),Yt=L("0-1",!1),Xt=L("1/2-1/2",!1),zt=L("*",!1),Zt=F("whitespace"),Ye=U([" ","	","\r",`
`],!1,!1),Jt=function(o,l){return $s(o,l)},es=function(o){return Object.fromEntries(o)},ts=function(o,l){return[o,l]},ss=function(o,l){return{root:o,marker:l}},is=function(o,l){return As(Ss(o),...l.flat())},rs=function(o,l,c,v,b){return ws(o,l,c,v,b)},ns=function(o){return o},os=function(o){return o.replace(/[\r\n]+/g," ")},as=function(o){return o.trim()},ls=function(o){return o},cs=function(o,l){return{result:o,comment:l}},a=t.peg$currPos|0,X=[{line:1,column:1}],D=a,oe=t.peg$maxFailExpected||[],g=t.peg$silentFails|0,J;if(t.startRule){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');n=i[t.startRule]}function L(o,l){return{type:"literal",text:o,ignoreCase:l}}function U(o,l,c){return{type:"class",parts:o,inverted:l,ignoreCase:c}}function fs(){return{type:"end"}}function F(o){return{type:"other",description:o}}function Xe(o){var l=X[o],c;if(l)return l;if(o>=X.length)c=X.length-1;else for(c=o;!X[--c];);for(l=X[c],l={line:l.line,column:l.column};c<o;)r.charCodeAt(c)===10?(l.line++,l.column=1):l.column++,c++;return X[o]=l,l}function ze(o,l,c){var v=Xe(o),b=Xe(l),S={source:s,start:{offset:o,line:v.line,column:v.column},end:{offset:l,line:b.line,column:b.column}};return S}function m(o){a<D||(a>D&&(D=a,oe=[]),oe.push(o))}function hs(o,l,c){return new Z(Z.buildMessage(o,l),o,l,c)}function Ze(){var o,l,c;return o=a,l=us(),c=gs(),o=Jt(l,c),o}function us(){var o,l,c;for(o=a,l=[],c=Je();c!==e;)l.push(c),c=Je();return c=M(),o=es(l),o}function Je(){var o,l,c,v,b,S,V;return g++,o=a,M(),r.charCodeAt(a)===91?(l=f,a++):(l=e,g===0&&m(St)),l!==e?(M(),c=ds(),c!==e?(M(),r.charCodeAt(a)===34?(v=u,a++):(v=e,g===0&&m(Ue)),v!==e?(b=ps(),r.charCodeAt(a)===34?(S=u,a++):(S=e,g===0&&m(Ue)),S!==e?(M(),r.charCodeAt(a)===93?(V=h,a++):(V=e,g===0&&m(wt)),V!==e?o=ts(c,b):(a=o,o=e)):(a=o,o=e)):(a=o,o=e)):(a=o,o=e)):(a=o,o=e),g--,o===e&&g===0&&m(kt),o}function ds(){var o,l,c;if(g++,o=a,l=[],c=r.charAt(a),_e.test(c)?a++:(c=e,g===0&&m(me)),c!==e)for(;c!==e;)l.push(c),c=r.charAt(a),_e.test(c)?a++:(c=e,g===0&&m(me));else l=e;return l!==e?o=r.substring(o,a):o=l,g--,o===e&&(l=e,g===0&&m(At)),o}function ps(){var o,l,c;for(g++,o=a,l=[],c=r.charAt(a),Oe.test(c)?a++:(c=e,g===0&&m(Qe));c!==e;)l.push(c),c=r.charAt(a),Oe.test(c)?a++:(c=e,g===0&&m(Qe));return o=r.substring(o,a),g--,l=e,g===0&&m($t),o}function gs(){var o,l,c;return o=a,l=et(),M(),c=ys(),c===e&&(c=null),M(),o=ss(l,c),o}function et(){var o,l,c,v;for(o=a,l=ve(),l===e&&(l=null),c=[],v=tt();v!==e;)c.push(v),v=tt();return o=is(l,c),o}function tt(){var o,l,c,v,b,S,V,ae;if(o=a,M(),_s(),M(),l=ms(),l!==e){for(c=vs(),c===e&&(c=null),v=[],b=st();b!==e;)v.push(b),b=st();for(b=M(),S=ve(),S===e&&(S=null),V=[],ae=it();ae!==e;)V.push(ae),ae=it();o=rs(l,c,v,S,V)}else a=o,o=e;return o}function _s(){var o,l,c,v,b,S;for(g++,o=a,l=[],c=r.charAt(a),re.test(c)?a++:(c=e,g===0&&m(ne));c!==e;)l.push(c),c=r.charAt(a),re.test(c)?a++:(c=e,g===0&&m(ne));if(r.charCodeAt(a)===46?(c=d,a++):(c=e,g===0&&m(Tt)),c!==e){for(v=M(),b=[],S=r.charAt(a),Me.test(S)?a++:(S=e,g===0&&m(Ge));S!==e;)b.push(S),S=r.charAt(a),Me.test(S)?a++:(S=e,g===0&&m(Ge));l=[l,c,v,b],o=l}else a=o,o=e;return g--,o===e&&(l=e,g===0&&m(Pt)),o}function ms(){var o,l,c,v,b,S;if(g++,o=a,l=a,r.substr(a,5)===_?(c=_,a+=5):(c=e,g===0&&m(It)),c===e&&(r.substr(a,3)===y?(c=y,a+=3):(c=e,g===0&&m(Lt)),c===e&&(r.substr(a,5)===p?(c=p,a+=5):(c=e,g===0&&m(qt)),c===e&&(r.substr(a,3)===w?(c=w,a+=3):(c=e,g===0&&m(Nt)),c===e))))if(c=a,v=r.charAt(a),_e.test(v)?a++:(v=e,g===0&&m(me)),v!==e){if(b=[],S=r.charAt(a),Ke.test(S)?a++:(S=e,g===0&&m(He)),S!==e)for(;S!==e;)b.push(S),S=r.charAt(a),Ke.test(S)?a++:(S=e,g===0&&m(He));else b=e;b!==e?(v=[v,b],c=v):(a=c,c=e)}else a=c,c=e;return c!==e?(v=r.charAt(a),Ct.test(v)?a++:(v=e,g===0&&m(Ot)),v===e&&(v=null),c=[c,v],l=c):(a=l,l=e),l!==e?o=r.substring(o,a):o=l,g--,o===e&&(l=e,g===0&&m(xt)),o}function vs(){var o,l,c;for(g++,o=a,l=[],c=r.charAt(a),Fe.test(c)?a++:(c=e,g===0&&m(je));c!==e;)l.push(c),l.length>=2?c=e:(c=r.charAt(a),Fe.test(c)?a++:(c=e,g===0&&m(je)));return l.length<1?(a=o,o=e):o=l,g--,o===e&&(l=e,g===0&&m(Mt)),o}function st(){var o,l,c,v,b;if(g++,o=a,M(),r.charCodeAt(a)===36?(l=E,a++):(l=e,g===0&&m(Ft)),l!==e){if(c=a,v=[],b=r.charAt(a),re.test(b)?a++:(b=e,g===0&&m(ne)),b!==e)for(;b!==e;)v.push(b),b=r.charAt(a),re.test(b)?a++:(b=e,g===0&&m(ne));else v=e;v!==e?c=r.substring(c,a):c=v,c!==e?o=ns(c):(a=o,o=e)}else a=o,o=e;return g--,o===e&&g===0&&m(Kt),o}function ve(){var o;return o=bs(),o===e&&(o=Es()),o}function bs(){var o,l,c,v,b;if(g++,o=a,r.charCodeAt(a)===123?(l=$,a++):(l=e,g===0&&m(Dt)),l!==e){for(c=a,v=[],b=r.charAt(a),Re.test(b)?a++:(b=e,g===0&&m(Ve));b!==e;)v.push(b),b=r.charAt(a),Re.test(b)?a++:(b=e,g===0&&m(Ve));c=r.substring(c,a),r.charCodeAt(a)===125?(v=A,a++):(v=e,g===0&&m(Bt)),v!==e?o=os(c):(a=o,o=e)}else a=o,o=e;return g--,o===e&&(l=e,g===0&&m(Rt)),o}function Es(){var o,l,c,v,b;if(g++,o=a,r.charCodeAt(a)===59?(l=Q,a++):(l=e,g===0&&m(Qt)),l!==e){for(c=a,v=[],b=r.charAt(a),De.test(b)?a++:(b=e,g===0&&m(We));b!==e;)v.push(b),b=r.charAt(a),De.test(b)?a++:(b=e,g===0&&m(We));c=r.substring(c,a),o=as(c)}else a=o,o=e;return g--,o===e&&(l=e,g===0&&m(Ut)),o}function it(){var o,l,c,v;return g++,o=a,M(),r.charCodeAt(a)===40?(l=pe,a++):(l=e,g===0&&m(Ht)),l!==e?(c=et(),c!==e?(M(),r.charCodeAt(a)===41?(v=ge,a++):(v=e,g===0&&m(jt)),v!==e?o=ls(c):(a=o,o=e)):(a=o,o=e)):(a=o,o=e),g--,o===e&&g===0&&m(Gt),o}function ys(){var o,l,c;return g++,o=a,r.substr(a,3)===Le?(l=Le,a+=3):(l=e,g===0&&m(Wt)),l===e&&(r.substr(a,3)===qe?(l=qe,a+=3):(l=e,g===0&&m(Yt)),l===e&&(r.substr(a,7)===Ne?(l=Ne,a+=7):(l=e,g===0&&m(Xt)),l===e&&(r.charCodeAt(a)===42?(l=yt,a++):(l=e,g===0&&m(zt))))),l!==e?(M(),c=ve(),c===e&&(c=null),o=cs(l,c)):(a=o,o=e),g--,o===e&&(l=e,g===0&&m(Vt)),o}function M(){var o,l;for(g++,o=[],l=r.charAt(a),Be.test(l)?a++:(l=e,g===0&&m(Ye));l!==e;)o.push(l),l=r.charAt(a),Be.test(l)?a++:(l=e,g===0&&m(Ye));return g--,l=e,g===0&&m(Zt),o}if(J=n(),t.peg$library)return{peg$result:J,peg$currPos:a,peg$FAILED:e,peg$maxFailExpected:oe,peg$maxFailPos:D};if(J!==e&&a===r.length)return J;throw J!==e&&a<r.length&&m(fs()),hs(oe,D<r.length?r.charAt(D):null,D<r.length?ze(D,D+1):ze(D,D))}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const fe=0xffffffffffffffffn;function Ee(r,t){return(r<<t|r>>64n-t)&0xffffffffffffffffn}function rt(r,t){return r*t&fe}function xs(r){return function(){let t=BigInt(r&fe),e=BigInt(r>>64n&fe);const s=rt(Ee(rt(t,5n),7n),9n);return e^=t,t=(Ee(t,24n)^e^e<<16n)&fe,e=Ee(e,37n),r=e<<64n|t,s}}const de=xs(0xa187eb39cdcaed8f31c4b365b102e01en),Is=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>de()))),Ls=Array.from({length:8},()=>de()),qs=Array.from({length:16},()=>de()),ye=de(),O="w",K="b",x="p",$e="n",he="b",se="r",j="q",I="k",Ce="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class le{constructor(t,e){P(this,"color");P(this,"from");P(this,"to");P(this,"piece");P(this,"captured");P(this,"promotion");P(this,"flags");P(this,"san");P(this,"lan");P(this,"before");P(this,"after");const{color:s,piece:i,from:n,to:f,flags:u,captured:h,promotion:d}=e,_=q(n),y=q(f);this.color=s,this.piece=i,this.from=_,this.to=y,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=_+y,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(const p in k)k[p]&u&&(this.flags+=W[p]);h&&(this.captured=h),d&&(this.promotion=d,this.lan+=d)}isCapture(){return this.flags.indexOf(W.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(W.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(W.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(W.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(W.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(W.BIG_PAWN)>-1}}const N=-1,W={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},k={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},Pe={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Ns={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Os={...Pe,...Ns},C={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},ke={b:[16,32,17,15],w:[-16,-32,-17,-15]},nt={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Ms=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Ks=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Fs={p:1,n:2,b:4,r:8,q:16,k:32},Rs="pnbrqkPNBRQK",ot=[$e,he,se,j],Ds=7,Bs=6,Us=1,Qs=0,ce={[I]:k.KSIDE_CASTLE,[j]:k.QSIDE_CASTLE},G={w:[{square:C.a1,flag:k.QSIDE_CASTLE},{square:C.h1,flag:k.KSIDE_CASTLE}],b:[{square:C.a8,flag:k.QSIDE_CASTLE},{square:C.h8,flag:k.KSIDE_CASTLE}]},Gs={b:Us,w:Bs},Se="--";function Y(r){return r>>4}function ie(r){return r&15}function gt(r){return"0123456789".indexOf(r)!==-1}function q(r){const t=ie(r),e=Y(r);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function ee(r){return r===O?K:O}function Hs(r){const t=r.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let f=0;f<i.length;f++){let u=0,h=!1;for(let d=0;d<i[f].length;d++)if(gt(i[f][d])){if(h)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};u+=parseInt(i[f][d],10),h=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[f][d]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};u+=1,h=!1}if(u!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const n=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:f,regex:u}of n){if(!u.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${f} king`};if((t[0].match(u)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${f} kings`}}return Array.from(i[0]+i[7]).some(f=>f.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function js(r,t){const e=r.from,s=r.to,i=r.piece;let n=0,f=0,u=0;for(let h=0,d=t.length;h<d;h++){const _=t[h].from,y=t[h].to,p=t[h].piece;i===p&&e!==_&&s===y&&(n++,Y(e)===Y(_)&&f++,ie(e)===ie(_)&&u++)}return n>0?f>0&&u>0?q(e):u>0?q(e).charAt(1):q(e).charAt(0):""}function H(r,t,e,s,i,n=void 0,f=k.NORMAL){const u=Y(s);if(i===x&&(u===Ds||u===Qs))for(let h=0;h<ot.length;h++){const d=ot[h];r.push({color:t,from:e,to:s,piece:i,captured:n,promotion:d,flags:f|k.PROMOTION})}else r.push({color:t,from:e,to:s,piece:i,captured:n,flags:f})}function at(r){let t=r.charAt(0);return t>="a"&&t<="h"?r.match(/[a-h]\d.*[a-h]\d/)?void 0:x:(t=t.toLowerCase(),t==="o"?I:t)}function we(r){return r.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class Vs{constructor(t=Ce,{skipValidation:e=!1}={}){P(this,"_board",new Array(128));P(this,"_turn",O);P(this,"_header",{});P(this,"_kings",{w:N,b:N});P(this,"_epSquare",-1);P(this,"_halfMoves",0);P(this,"_moveNumber",0);P(this,"_history",[]);P(this,"_comments",{});P(this,"_castling",{w:0,b:0});P(this,"_hash",0n);P(this,"_positionCount",new Map);this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:N,b:N},this._turn=O,this._castling={w:0,b:0},this._epSquare=N,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...Os},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let i=t.split(/\s+/);if(i.length>=2&&i.length<6){const u=["-","-","0","1"];t=i.concat(u.slice(-(6-i.length))).join(" ")}if(i=t.split(/\s+/),!e){const{ok:u,error:h}=Hs(t);if(!u)throw new Error(h)}const n=i[0];let f=0;this.clear({preserveHeaders:s});for(let u=0;u<n.length;u++){const h=n.charAt(u);if(h==="/")f+=8;else if(gt(h))f+=parseInt(h,10);else{const d=h<"a"?O:K;this._put({type:h.toLowerCase(),color:d},q(f)),f++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=k.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=k.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=k.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=k.QSIDE_CASTLE),this._epSquare=i[3]==="-"?N:C[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){var f,u;let e=0,s="";for(let h=C.a8;h<=C.h1;h++){if(this._board[h]){e>0&&(s+=e,e=0);const{color:d,type:_}=this._board[h];s+=d===O?_.toUpperCase():_.toLowerCase()}else e++;h+1&136&&(e>0&&(s+=e),h!==C.h1&&(s+="/"),e=0,h+=8)}let i="";this._castling[O]&k.KSIDE_CASTLE&&(i+="K"),this._castling[O]&k.QSIDE_CASTLE&&(i+="Q"),this._castling[K]&k.KSIDE_CASTLE&&(i+="k"),this._castling[K]&k.QSIDE_CASTLE&&(i+="q"),i=i||"-";let n="-";if(this._epSquare!==N)if(t)n=q(this._epSquare);else{const h=this._epSquare+(this._turn===O?16:-16),d=[h+1,h-1];for(const _ of d){if(_&136)continue;const y=this._turn;if(((f=this._board[_])==null?void 0:f.color)===y&&((u=this._board[_])==null?void 0:u.type)===x){this._makeMove({color:y,from:_,to:this._epSquare,piece:x,captured:x,flags:k.EP_CAPTURE});const p=!this._isKingAttacked(y);if(this._undoMove(),p){n=q(this._epSquare);break}}}}return[s,this._turn,i,n,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:e,type:s}=this._board[t],i={w:0,b:1}[e],n={p:0,n:1,b:2,r:3,q:4,k:5}[s];return Is[i][n][t]}_epKey(){return this._epSquare===N?0n:Ls[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return qs[t]}_computeHash(){let t=0n;for(let e=C.a8;e<=C.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=ye),t}_updateSetup(t){this._history.length>0||(t!==Ce?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(Ce)}get(t){return this._board[C[t]]}findPiece(t){var s;const e=[];for(let i=C.a8;i<=C.h1;i++){if(i&136){i+=7;continue}!this._board[i]||((s=this._board[i])==null?void 0:s.color)!==t.color||this._board[i].color===t.color&&this._board[i].type===t.type&&e.push(q(i))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if(Rs.indexOf(t.toLowerCase())===-1||!(s in C))return!1;const i=C[s];if(t==I&&!(this._kings[e]==N||this._kings[e]==i))return!1;const n=this._board[i];return n&&n.type===I&&(this._kings[n.color]=N),this._set(i,{type:t,color:e}),t===I&&(this._kings[e]=i),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const e=this.get(t);return this._clear(C[t]),e&&e.type===I&&(this._kings[e.color]=N),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){var s,i,n,f,u,h,d,_,y,p,w,E;this._hash^=this._castlingKey();const t=((s=this._board[C.e1])==null?void 0:s.type)===I&&((i=this._board[C.e1])==null?void 0:i.color)===O,e=((n=this._board[C.e8])==null?void 0:n.type)===I&&((f=this._board[C.e8])==null?void 0:f.color)===K;(!t||((u=this._board[C.a1])==null?void 0:u.type)!==se||((h=this._board[C.a1])==null?void 0:h.color)!==O)&&(this._castling.w&=-65),(!t||((d=this._board[C.h1])==null?void 0:d.type)!==se||((_=this._board[C.h1])==null?void 0:_.color)!==O)&&(this._castling.w&=-33),(!e||((y=this._board[C.a8])==null?void 0:y.type)!==se||((p=this._board[C.a8])==null?void 0:p.color)!==K)&&(this._castling.b&=-65),(!e||((w=this._board[C.h8])==null?void 0:w.type)!==se||((E=this._board[C.h8])==null?void 0:E.color)!==K)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){var n,f;if(this._epSquare===N)return;const t=this._epSquare+(this._turn===O?-16:16),e=this._epSquare+(this._turn===O?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||((n=this._board[e])==null?void 0:n.color)!==ee(this._turn)||((f=this._board[e])==null?void 0:f.type)!==x){this._hash^=this._epKey(),this._epSquare=N;return}const i=u=>{var h,d;return!(u&136)&&((h=this._board[u])==null?void 0:h.color)===this._turn&&((d=this._board[u])==null?void 0:d.type)===x};s.some(i)||(this._hash^=this._epKey(),this._epSquare=N)}_attacked(t,e,s){const i=[];for(let n=C.a8;n<=C.h1;n++){if(n&136){n+=7;continue}if(this._board[n]===void 0||this._board[n].color!==t)continue;const f=this._board[n],u=n-e;if(u===0)continue;const h=u+119;if(Ms[h]&Fs[f.type]){if(f.type===x){if(u>0&&f.color===O||u<=0&&f.color===K)if(s)i.push(q(n));else return!0;continue}if(f.type==="n"||f.type==="k")if(s){i.push(q(n));continue}else return!0;const d=Ks[h];let _=n+d,y=!1;for(;_!==e;){if(this._board[_]!=null){y=!0;break}_+=d}if(!y)if(s){i.push(q(n));continue}else return!0}}return s?i:!1}attackers(t,e){return e?this._attacked(e,C[t],!0):this._attacked(this._turn,C[t],!0)}_isKingAttacked(t){const e=this._kings[t];return e===-1?!1:this._attacked(ee(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,C[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},e=[];let s=0,i=0;for(let n=C.a8;n<=C.h1;n++){if(i=(i+1)%2,n&136){n+=7;continue}const f=this._board[n];f&&(t[f.type]=f.type in t?t[f.type]+1:1,f.type===he&&e.push(i),s++)}if(s===2)return!0;if(s===3&&(t[he]===1||t[$e]===1))return!0;if(s===t[he]+2){let n=0;const f=e.length;for(let u=0;u<f;u++)n+=e[u];if(n===0||n===f)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){const i=this._moves({square:e,piece:s});return t?i.map(n=>new le(this,n)):i.map(n=>this._moveToSan(n,i))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){var w;const i=s?s.toLowerCase():void 0,n=e==null?void 0:e.toLowerCase(),f=[],u=this._turn,h=ee(u);let d=C.a8,_=C.h1,y=!1;if(i)if(i in C)d=_=C[i],y=!0;else return[];for(let E=d;E<=_;E++){if(E&136){E+=7;continue}if(!this._board[E]||this._board[E].color===h)continue;const{type:$}=this._board[E];let A;if($===x){if(n&&n!==$)continue;A=E+ke[u][0],this._board[A]||(H(f,u,E,A,x),A=E+ke[u][1],Gs[u]===Y(E)&&!this._board[A]&&H(f,u,E,A,x,void 0,k.BIG_PAWN));for(let Q=2;Q<4;Q++)A=E+ke[u][Q],!(A&136)&&(((w=this._board[A])==null?void 0:w.color)===h?H(f,u,E,A,x,this._board[A].type,k.CAPTURE):A===this._epSquare&&H(f,u,E,A,x,x,k.EP_CAPTURE))}else{if(n&&n!==$)continue;for(let Q=0,pe=nt[$].length;Q<pe;Q++){const ge=nt[$][Q];for(A=E;A+=ge,!(A&136);){if(!this._board[A])H(f,u,E,A,$);else{if(this._board[A].color===u)break;H(f,u,E,A,$,this._board[A].type,k.CAPTURE);break}if($===$e||$===I)break}}}}if((n===void 0||n===I)&&(!y||_===this._kings[u])){if(this._castling[u]&k.KSIDE_CASTLE){const E=this._kings[u],$=E+2;!this._board[E+1]&&!this._board[$]&&!this._attacked(h,this._kings[u])&&!this._attacked(h,E+1)&&!this._attacked(h,$)&&H(f,u,this._kings[u],$,I,void 0,k.KSIDE_CASTLE)}if(this._castling[u]&k.QSIDE_CASTLE){const E=this._kings[u],$=E-2;!this._board[E-1]&&!this._board[E-2]&&!this._board[E-3]&&!this._attacked(h,this._kings[u])&&!this._attacked(h,E-1)&&!this._attacked(h,$)&&H(f,u,this._kings[u],$,I,void 0,k.QSIDE_CASTLE)}}if(!t||this._kings[u]===-1)return f;const p=[];for(let E=0,$=f.length;E<$;E++)this._makeMove(f[E]),this._isKingAttacked(u)||p.push(f[E]),this._undoMove();return p}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(Se,e);else if(typeof t=="object"){const n=this._moves();for(let f=0,u=n.length;f<u;f++)if(t.from===q(n[f].from)&&t.to===q(n[f].to)&&(!("promotion"in n[f])||t.promotion===n[f].promotion)){s=n[f];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&k.NULL_MOVE)throw new Error("Null move not allowed when in check");const i=new le(this,s);return this._makeMove(s),this._incPositionCount(),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){var i,n,f,u;const e=this._turn,s=ee(e);if(this._push(t),t.flags&k.NULL_MOVE){e===K&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=N;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&k.EP_CAPTURE&&(this._turn===K?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===I){if(this._kings[e]=t.to,t.flags&k.KSIDE_CASTLE){const h=t.to-1,d=t.to+1;this._movePiece(d,h)}else if(t.flags&k.QSIDE_CASTLE){const h=t.to+1,d=t.to-2;this._movePiece(d,h)}this._castling[e]=0}if(this._castling[e]){for(let h=0,d=G[e].length;h<d;h++)if(t.from===G[e][h].square&&this._castling[e]&G[e][h].flag){this._castling[e]^=G[e][h].flag;break}}if(this._castling[s]){for(let h=0,d=G[s].length;h<d;h++)if(t.to===G[s][h].square&&this._castling[s]&G[s][h].flag){this._castling[s]^=G[s][h].flag;break}}if(this._hash^=this._castlingKey(),t.flags&k.BIG_PAWN){let h;e===K?h=t.to-16:h=t.to+16,!(t.to-1&136)&&((i=this._board[t.to-1])==null?void 0:i.type)===x&&((n=this._board[t.to-1])==null?void 0:n.color)===s||!(t.to+1&136)&&((f=this._board[t.to+1])==null?void 0:f.type)===x&&((u=this._board[t.to+1])==null?void 0:u.color)===s?(this._epSquare=h,this._hash^=this._epKey()):this._epSquare=N}else this._epSquare=N;t.piece===x?this._halfMoves=0:t.flags&(k.CAPTURE|k.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===K&&this._moveNumber++,this._turn=s,this._hash^=ye}undo(){const t=this._hash,e=this._undoMove();if(e){const s=new le(this,e);return this._decPositionCount(t),s}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=ye;const s=this._turn,i=ee(s);if(e.flags&k.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&k.EP_CAPTURE){let n;s===K?n=e.to-16:n=e.to+16,this._set(n,{type:x,color:i})}else this._set(e.to,{type:e.captured,color:i});if(e.flags&(k.KSIDE_CASTLE|k.QSIDE_CASTLE)){let n,f;e.flags&k.KSIDE_CASTLE?(n=e.to+1,f=e.to-1):(n=e.to-2,f=e.to+1),this._movePiece(f,n)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){const s=[];let i=!1;for(const p in this._header)this._header[p]&&s.push(`[${p} "${this._header[p]}"]`+t),i=!0;i&&this._history.length&&s.push(t);const n=p=>{const w=this._comments[this.fen()];if(typeof w<"u"){const E=p.length>0?" ":"";p=`${p}${E}{${w}}`}return p},f=[];for(;this._history.length>0;)f.push(this._undoMove());const u=[];let h="";for(f.length===0&&u.push(n(""));f.length>0;){h=n(h);const p=f.pop();if(!p)break;if(!this._history.length&&p.color==="b"){const w=`${this._moveNumber}. ...`;h=h?`${h} ${w}`:w}else p.color==="w"&&(h.length&&u.push(h),h=this._moveNumber+".");h=h+" "+this._moveToSan(p,this._moves({legal:!0})),this._makeMove(p)}if(h.length&&u.push(n(h)),u.push(this._header.Result||"*"),e===0)return s.join("")+u.join(" ");const d=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},_=function(p,w){for(const E of w.split(" "))if(E){if(p+E.length>e){for(;d();)p--;s.push(t),p=0}s.push(E),p+=E.length,s.push(" "),p++}return d()&&p--,p};let y=0;for(let p=0;p<u.length;p++){if(y+u[p].length>e&&u[p].includes("{")){y=_(y,u[p]);continue}y+u[p].length>e&&p!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),y=0):p!==0&&(s.push(" "),y++),s.push(u[p]),y+=u[p].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??Pe[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=Pe[t]||null,!0):!1}getHeaders(){const t={};for(const[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));const i=Ts(t);this.reset();const n=i.headers;let f="";for(const d in n)d.toLowerCase()==="fen"&&(f=n[d]),this.header(d,n[d]);if(!e)f&&this.load(f,{preserveHeaders:!0});else if(n.SetUp==="1"){if(!("FEN"in n))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(n.FEN,{preserveHeaders:!0})}let u=i.root;for(;u;){if(u.move){const d=this._moveFromSan(u.move,e);if(d==null)throw new Error(`Invalid move in PGN: ${u.move}`);this._makeMove(d),this._incPositionCount()}u.comment!==void 0&&(this._comments[this.fen()]=u.comment),u=u.variations[0]}const h=i.result;h&&Object.keys(this._header).length&&this._header.Result!==h&&this.setHeader("Result",h)}_moveToSan(t,e){let s="";if(t.flags&k.KSIDE_CASTLE)s="O-O";else if(t.flags&k.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&k.NULL_MOVE)return Se;if(t.piece!==x){const i=js(t,e);s+=t.piece.toUpperCase()+i}t.flags&(k.CAPTURE|k.EP_CAPTURE)&&(t.piece===x&&(s+=q(t.from)[0]),s+="x"),s+=q(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=we(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==Se)return{color:this._turn,from:0,to:0,piece:"k",flags:k.NULL_MOVE};let i=at(s),n=this._moves({legal:!0,piece:i});for(let p=0,w=n.length;p<w;p++)if(s===we(this._moveToSan(n[p],n)))return n[p];if(e)return null;let f,u,h,d,_,y=!1;if(u=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),u?(f=u[1],h=u[2],d=u[3],_=u[4],h.length==1&&(y=!0)):(u=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),u&&(f=u[1],h=u[2],d=u[3],_=u[4],h.length==1&&(y=!0))),i=at(s),n=this._moves({legal:!0,piece:f||i}),!d)return null;for(let p=0,w=n.length;p<w;p++)if(h){if((!f||f.toLowerCase()==n[p].piece)&&C[h]==n[p].from&&C[d]==n[p].to&&(!_||_.toLowerCase()==n[p].promotion))return n[p];if(y){const E=q(n[p].from);if((!f||f.toLowerCase()==n[p].piece)&&C[d]==n[p].to&&(h==E[0]||h==E[1])&&(!_||_.toLowerCase()==n[p].promotion))return n[p]}}else if(s===we(this._moveToSan(n[p],n)).replace("x",""))return n[p];return null}ascii(){let t=`   +------------------------+
`;for(let e=C.a8;e<=C.h1;e++){if(ie(e)===0&&(t+=" "+"87654321"[Y(e)]+" |"),this._board[e]){const s=this._board[e].type,n=this._board[e].color===O?s.toUpperCase():s.toLowerCase();t+=" "+n+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const e=this._moves({legal:!1});let s=0;const i=this._turn;for(let n=0,f=e.length;n<f;n++)this._makeMove(e[n]),this._isKingAttacked(i)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let e=[];for(let s=C.a8;s<=C.h1;s++)this._board[s]==null?e.push(null):e.push({square:q(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in C){const e=C[t];return(Y(e)+ie(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){const i=e.pop();if(!i)break;t?s.push(new le(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){const t=[],e={},s=i=>{i in this._comments&&(e[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){const i=t.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(const i of[I,j])e[i]!==void 0&&(e[i]?this._castling[t]|=ce[i]:this._castling[t]&=~ce[i]);this._updateCastlingRights();const s=this.getCastlingRights(t);return(e[I]===void 0||e[I]===s[I])&&(e[j]===void 0||e[j]===s[j])}getCastlingRights(t){return{[I]:(this._castling[t]&ce[I])!==0,[j]:(this._castling[t]&ce[j])!==0}}moveNumber(){return this._moveNumber}}const lt=document.getElementById("chessboard"),_t=document.getElementById("overlay"),ct=document.getElementById("modal-message"),Ws=document.getElementById("modal-btn"),R=document.getElementById("coach-message"),Ys=document.getElementById("xp-val"),Xs=document.getElementById("xp-bar-fill"),zs=document.getElementById("level-num"),ue=document.getElementById("move-history"),Zs=document.getElementById("difficulty-select"),ft=document.querySelectorAll(".theme-swatch"),Js=document.getElementById("turn-indicator"),ei=document.getElementById("new-game-btn"),ti=document.getElementById("captured-white"),si=document.getElementById("captured-black");let T=new Vs,Ae=null,ht=null,ut="w",te=0,dt=1;const mt={p:{w:"https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg",b:"https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg"},n:{w:"https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg",b:"https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg"},b:{w:"https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg",b:"https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg"},r:{w:"https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg",b:"https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg"},q:{w:"https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg",b:"https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg"},k:{w:"https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg",b:"https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg"}};function xe(){T.reset(),z(),Ie(),R.textContent="Good luck! You are playing as White. Drag a pawn to start!",ue.innerHTML="",_t.classList.add("hidden"),bt(),Et("classic")}const ii=window.AudioContext||window.webkitAudioContext,B=new ii;function vt(r){B.state==="suspended"&&B.resume();const t=B.createOscillator(),e=B.createGain();t.connect(e),e.connect(B.destination),t.type="square",t.frequency.setValueAtTime(440,B.currentTime),t.frequency.setValueAtTime(554,B.currentTime+.2),t.frequency.setValueAtTime(659,B.currentTime+.4),e.gain.setValueAtTime(.1,B.currentTime),e.gain.linearRampToValueAtTime(0,B.currentTime+.8),t.start(),t.stop(B.currentTime+.8)}function ri(r,t){return mt[r][t]}function z(){lt.innerHTML="";const r=T.board();for(let t=0;t<8;t++)for(let e=0;e<8;e++){const s=document.createElement("div");s.classList.add("square");const i=(t+e)%2===0;s.classList.add(i?"light":"dark");const n=String.fromCharCode(97+e),f=8-t,u=`${n}${f}`;s.dataset.square=u;const h=r[t][e];if(h){const d=document.createElement("div");d.classList.add("piece"),d.style.backgroundImage=`url(${ri(h.type,h.color)})`,d.dataset.square=u,d.dataset.type=h.type,d.dataset.color=h.color,h.color===ut&&!T.isGameOver()&&d.addEventListener("pointerdown",oi),h.color===ut&&ni(u,h.color,d),s.appendChild(d)}lt.appendChild(s)}}function ni(r,t,e){const s=t==="w"?"b":"w";try{if(T.isAttacked(r,s)){const i=T.isAttacked(r,t);e.classList.add("under-attack-undefended")}}catch{}}function oi(r){r.preventDefault();const t=r.target,e=t.dataset.square;Ae=t,ht=e;const s=t.cloneNode(!0);s.classList.add("dragging"),s.style.position="absolute",s.style.width="60px",s.style.height="60px",s.style.left=`${r.clientX-30}px`,s.style.top=`${r.clientY-30}px`,document.body.appendChild(s),Ae.style.opacity="0.3",ai(e);function i(f){s.style.left=`${f.clientX-30}px`,s.style.top=`${f.clientY-30}px`}function n(f){document.removeEventListener("pointermove",i),document.removeEventListener("pointerup",n),s.remove(),Ae.style.opacity="1",s.style.display="none";const u=document.elementFromPoint(f.clientX,f.clientY);let h=null,d=u;for(;d;){if(d.classList.contains("square")){h=d.dataset.square;break}if(d.classList.contains("piece")){h=d.dataset.square;break}d=d.parentElement}h?li(ht,h):z()}document.addEventListener("pointermove",i),document.addEventListener("pointerup",n)}function ai(r){document.querySelectorAll(".highlight, .highlight-capture").forEach(e=>{e.classList.remove("highlight","highlight-capture")});const t=T.moves({square:r,verbose:!0});t.forEach(e=>{const s=document.querySelector(`.square[data-square="${e.to}"]`);s&&(e.flags.includes("c")||e.flags.includes("e")?s.classList.add("highlight-capture"):s.classList.add("highlight"))}),t.length>0?R.textContent="You selected a piece! It can move to the green dots!":R.textContent="Uh oh, this piece is stuck! Try another one."}function li(r,t){try{const e=T.move({from:r,to:t,promotion:"q"});e?(ci(e),z(),Ie(),T.isGameOver()||(R.textContent="Great move! Now let me think...",setTimeout(hi,500+Math.random()*1e3))):(R.textContent="Oops! You can't go there. Try a green circle!",z())}catch{z()}}function ci(r){let t=0;r.flags.includes("k")||r.flags.includes("q")?(R.textContent="King safety is important! Good castle! +15 XP",t+=15):r.flags.includes("c")||r.flags.includes("e")?(t+=10,R.textContent="Awesome capture! +10 XP!"):r.flags.includes("p")||r.flags.includes("cp")?(t+=20,R.textContent="Promotion! You got a Queen! +20 XP!"):(R.textContent="Nice move! Keep controlling the center!",t+=2),Te(t)}function Te(r){te+=r,te>=100&&(te-=100,dt++,R.textContent="LEVEL UP! You are getting stronger!",vt()),Ys.textContent=te,zs.textContent=dt,Xs.style.width=`${te}%`}function Ie(){const r=T.history();if(r[r.length-1],ue.innerHTML=r.map((t,e)=>`${e%2===0?e/2+1+".":""} ${t}`).join(" "),ue.scrollTop=ue.scrollHeight,T.inCheck()){const t=fi(T.turn()),e=document.querySelector(`.square[data-square="${t}"]`);e&&e.classList.add("in-check"),R.textContent="Watch out! Your King is in danger!"}if(T.isGameOver()){let t="";T.isCheckmate()?T.turn()==="b"?(t="Checkmate! You won! +50 XP!",Te(50)):t="Oh no! Checkmate. The computer won.":T.isDraw()&&(t="It's a draw! Good game!",Te(20)),ct.textContent=t,ct.textContent=t,_t.classList.remove("hidden"),vt()}bt(),Js.textContent=T.turn()==="w"?"White's Turn":"Black's Turn"}function bt(){const r={p:8,n:2,b:2,r:2,q:1,k:1},t={p:0,n:0,b:0,r:0,q:0,k:0},e={p:0,n:0,b:0,r:0,q:0,k:0};T.board().forEach(n=>{n.forEach(f=>{f&&(f.color==="w"?t[f.type]++:e[f.type]++)})});const s=[],i=[];["p","n","b","r","q"].forEach(n=>{let f=r[n]-e[n];if(f>0)for(let h=0;h<f;h++)s.push(n);let u=r[n]-t[n];if(u>0)for(let h=0;h<u;h++)i.push(n)}),pt(ti,s,"b"),pt(si,i,"w")}function pt(r,t,e){r.innerHTML="",t.forEach(s=>{const i=document.createElement("div");i.classList.add("captured-piece"),i.style.backgroundImage=`url(${mt[s][e]})`,r.appendChild(i)})}function fi(r){const t=T.board();for(let e=0;e<8;e++)for(let s=0;s<8;s++){const i=t[e][s];if(i&&i.type==="k"&&i.color===r){const n=String.fromCharCode(97+s),f=8-e;return`${n}${f}`}}return null}function hi(){const r=parseInt(Zs.value),t=T.moves({verbose:!0});if(t.length===0)return;let e=null;if(r===1){const d=Math.floor(Math.random()*t.length);e=t[d]}else if(r===2){const d=t.filter(_=>_.flags.includes("c")||_.flags.includes("e"));d.length>0&&Math.random()<.7?e=d[Math.floor(Math.random()*d.length)]:e=t[Math.floor(Math.random()*t.length)]}else{let d=1/0,_=[];const y={p:10,n:30,b:30,r:50,q:90,k:900};for(let p of t){T.move(p.san);let w=0;T.board().forEach(E=>{E.forEach($=>{if($){const A=y[$.type];w+=$.color==="w"?A:-A}})}),w+=(Math.random()-.5)*5,T.undo(),w<d?(d=w,_=[p]):Math.abs(w-d)<1&&_.push(p)}e=_[Math.floor(Math.random()*_.length)]}T.move(e.san);const s=ui(e.piece),i=e.from,n=e.to;let f=`Computer moved ${s} from ${i} to ${n}.`;e.flags.includes("c")||e.flags.includes("e")?f+=" It captured your piece! Oh no!":T.inCheck()?f+=" Your King is in check!":f+=" Your turn!",R.textContent=f,z(),Ie();const u=document.querySelector(`.square[data-square="${e.from}"]`),h=document.querySelector(`.square[data-square="${e.to}"]`);u&&u.classList.add("last-move"),h&&h.classList.add("last-move")}function ui(r){return{p:"Pawn",n:"Knight",b:"Bishop",r:"Rook",q:"Queen",k:"King"}[r]||"Piece"}ei.addEventListener("click",()=>{xe()});ft.forEach(r=>{r.addEventListener("click",t=>{ft.forEach(e=>e.classList.remove("active")),t.target.classList.add("active"),Et(t.target.dataset.theme)})});function Et(r){const t=document.documentElement;r==="blue"?(t.style.setProperty("--board-light","#EEF2FF"),t.style.setProperty("--board-dark","#6366F1")):r==="candy"?(t.style.setProperty("--board-light","#FFF1F2"),t.style.setProperty("--board-dark","#FB7185")):r==="wood"?(t.style.setProperty("--board-light","#EAD8B1"),t.style.setProperty("--board-dark","#966F33")):(t.style.setProperty("--board-light","#F0FDF4"),t.style.setProperty("--board-dark","#4ADE80"))}Ws.addEventListener("click",()=>{xe()});xe();
